{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'orders/orders.css' %}">
{% endblock %}

{% block content %}
<div class="page-orders-edit">
    <div class="container py-5 d-flex justify-content-center">
        <div class="card shadow-lg bg-dark text-light w-100 no-motion" style="max-width: 950px; border-radius: 1rem;">
            <div class="card-body p-5">
                <!-- Title -->
                <h2 class="fw-bold mb-4 text-center text-light">
                    {% if form.instance.pk %}
                    <i class="bi bi-pencil-square text-danger"></i> Edit Order
                    {% else %}
                    <i class="bi bi-cart-plus text-danger"></i> New Order
                    {% endif %}
                </h2>

                <!-- Order Form -->
                <form method="post" id="orderForm" novalidate>
                    {% csrf_token %}

                    <!-- Basic Info -->
                    <div class="row g-4">
                        <div class="col-md-6">{{ form.order_type }}</div>
                        {% if form.instance.pk %}
                        <div class="col-md-6">{{ form.status }}</div>
                        {% endif %}
                    </div>
                    <div class="row g-4 mt-2">
                        <div class="col-md-6">{{ form.customer }}</div>
                        <div class="col-md-6">{{ form.supplier }}</div>
                    </div>

                    <!-- Items -->
                    <h4 class="text-danger mt-5 mb-3"><i class="bi bi-box-seam"></i> Order Items</h4>
                    {{ formset.management_form }}

                    <div class="table-responsive">
                        <table class="table table-dark align-middle mb-0 no-hover-table" id="orderItemsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Item</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-center">Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in formset %}
                                <tr>
                                    <td class="cell-relative">
                                        <input type="text" class="form-control item-search mb-2"
                                            placeholder="Search item..." data-input-id="{{ f.item.id_for_label }}">
                                        {{ f.item }}
                                    </td>
                                    <td class="text-center">{{ f.quantity }}</td>
                                    <td class="price-field text-end">{{ f.price }}</td>
                                    <td class="row-total fw-semibold text-end">$0.00</td>
                                    <td class="text-center">{{ f.DELETE }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-dark">
                                <tr>
                                    <th colspan="3" class="text-end">Grand Total</th>
                                    <th id="grandTotal" class="fw-bold text-success text-end">$0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Submit -->
                    <div class="d-grid mt-5">
                        <button type="submit" class="btn btn-danger btn-lg rounded-pill">
                            <i class="bi bi-check-circle"></i> Save Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ====== Live Item Search ======
    function closeAllDropdowns() {
        document.querySelectorAll(".live-dropdown").forEach(dd => dd.remove());
    }
    document.addEventListener("click", e => {
        if (!e.target.closest(".cell-relative")) closeAllDropdowns();
    });

    document.querySelectorAll(".item-search").forEach(input => {
        input.addEventListener("keyup", function () {
            const q = this.value.trim();
            const hiddenInputId = this.dataset.inputId;
            closeAllDropdowns();
            if (q.length < 2) return;

            fetch(`/orders/search-items/?q=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(items => {
                    if (!items.length) return;
                    const dropdown = document.createElement("ul");
                    dropdown.className = "list-group position-absolute live-dropdown";
                    dropdown.style.width = this.offsetWidth + "px";

                    items.forEach(item => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action";
                        li.textContent = `${item.name} ($${item.price})`;
                        li.onclick = () => {
                            document.getElementById(hiddenInputId).value = item.id;
                            this.value = item.name;
                            dropdown.remove();
                            const priceInput = this.closest("tr").querySelector(".price-field input");
                            if (priceInput) priceInput.value = item.price;
                            updateTotals();
                        };
                        dropdown.appendChild(li);
                    });
                    this.parentNode.appendChild(dropdown);
                });
        });
    });

    // ====== Totals Calculation ======
    function updateTotals() {
        let grand = 0;
        document.querySelectorAll("#orderItemsTable tbody tr").forEach(row => {
            const qty = parseFloat(row.querySelector("input[name$='quantity']")?.value) || 0;
            const price = parseFloat(row.querySelector("input[name$='price']")?.value) || 0;
            const total = qty * price;
            row.querySelector(".row-total").textContent = `$${total.toFixed(2)}`;
            grand += total;
        });
        document.getElementById("grandTotal").textContent = `$${grand.toFixed(2)}`;
    }

    document.querySelectorAll("input[name$='quantity'], input[name$='price']")
        .forEach(i => i.addEventListener("input", updateTotals));

    updateTotals();
</script>
{% endblock %}