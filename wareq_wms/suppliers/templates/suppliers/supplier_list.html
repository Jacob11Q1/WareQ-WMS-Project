{% extends "base.html" %}
{% block content %}
<div class="container py-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-light">
            <i class="bi bi-truck text-danger"></i> Suppliers
        </h2>
        <a href="{% url 'suppliers:supplier_create' %}" class="btn btn-danger shadow-sm">
            <i class="bi bi-building"></i> Add Supplier
        </a>
    </div>

    <!-- Flash Messages -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-info-circle"></i> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Stat Card -->
    <div class="card shadow-lg stat-card mb-4 text-center bg-dark text-light border-0">
        <div class="card-body">
            <i class="bi bi-buildings display-6 text-danger"></i>
            <h2 class="fw-bold text-danger mt-2">{{ total_suppliers }}</h2>
            <p class="mb-0">Total Suppliers</p>
        </div>
    </div>

    <!-- Filters -->
    <form id="filterForm" class="row g-2 mb-3">
        <div class="col-md-6">
            <input type="text" name="search" class="form-control" placeholder="Search name, email, phone...">
        </div>
        <div class="col-md-2">
            <select name="active" class="form-select">
                <option value="">All</option>
                <option value="1">Active only</option>
                <option value="0">Inactive only</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="page_size" class="form-select">
                <option>10</option>
                <option>25</option>
                <option>50</option>
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-outline-light"><i class="bi bi-search"></i> Apply</button>
        </div>
    </form>

    <!-- Supplier Table -->
    <div class="card shadow-lg bg-dark text-light border-0">
        <div class="card-body table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead class="text-danger">
                    <tr>
                        <th><i class="bi bi-hash"></i></th>
                        <th><i class="bi bi-building"></i> Name</th>
                        <th><i class="bi bi-envelope"></i> Email</th>
                        <th><i class="bi bi-telephone"></i> Phone</th>
                        <th><i class="bi bi-geo-alt"></i> Address</th>
                        <th><i class="bi bi-calendar-date"></i> Added</th>
                        <th><i class="bi bi-shield-check"></i> Status</th>
                        <th><i class="bi bi-tools"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="suppliersBody">
                    {% for supplier in suppliers %}
                    <tr class="hover-glow">
                        <td>{{ forloop.counter }}</td>
                        <td class="fw-semibold"><i class="bi bi-building text-danger"></i> {{ supplier.name }}</td>
                        <td>{{ supplier.email }}</td>
                        <td>{{ supplier.phone|default:"-" }}</td>
                        <td>{{ supplier.address|default:"-" }}</td>
                        <td>{{ supplier.created_at|date:"M d, Y" }}</td>
                        <td>
                            {% if supplier.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'suppliers:supplier_update' supplier.id %}"
                                class="btn btn-sm btn-outline-light me-1" title="Edit Supplier"><i
                                    class="bi bi-pencil"></i></a>
                            <a href="{% url 'suppliers:supplier_delete' supplier.id %}" class="btn btn-sm btn-danger"
                                title="Deactivate"><i class="bi bi-trash"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-emoji-frown display-6"></i>
                            <p class="mt-2">No suppliers found. Add your first one!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pager -->
            <nav class="mt-3">
                <ul class="pagination justify-content-center" id="pager"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- Small CSS Upgrade -->
<style>
    .hover-glow:hover {
        background-color: #2b2b2b !important;
        box-shadow: inset 0 0 8px rgba(255, 0, 0, 0.5);
        transition: 0.3s;
    }
</style>

<!-- AJAX script -->
<script>
    const form = document.getElementById('filterForm');
    const bodyEl = document.getElementById('suppliersBody');
    const pager = document.getElementById('pager');

    function fetchList(page = 1) {
        const params = new URLSearchParams(new FormData(form));
        params.set('page', page);
        fetch(`/suppliers/api/list/?${params.toString()}`)
            .then(r => r.json())
            .then(data => {
                bodyEl.innerHTML = '';
                if (!data.results.length) {
                    bodyEl.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-emoji-frown display-6"></i><p class="mt-2">No suppliers found.</p></td></tr>`;
                } else {
                    data.results.forEach((s, idx) => {
                        bodyEl.insertAdjacentHTML('beforeend', `
            <tr class="hover-glow">
              <td>${((data.page - 1) * parseInt(form.page_size.value || 10)) + idx + 1}</td>
              <td class="fw-semibold"><i class="bi bi-building text-danger"></i> ${s.name}</td>
              <td>${s.email}</td>
              <td>${s.phone}</td>
              <td>${s.address}</td>
              <td>${s.created}</td>
              <td>${s.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
              <td>
                <a href="${s.edit_url}" class="btn btn-sm btn-outline-light me-1" title="Edit Supplier"><i class="bi bi-pencil"></i></a>
                <a href="${s.delete_url}" class="btn btn-sm btn-danger" title="Deactivate"><i class="bi bi-trash"></i></a>
              </td>
            </tr>
          `);
                    });
                }
                pager.innerHTML = '';
                const liPrev = `<li class="page-item ${data.has_prev ? '' : 'disabled'}"><a class="page-link" href="#" data-page="${data.page - 1}">Previous</a></li>`;
                const liInfo = `<li class="page-item disabled"><span class="page-link">Page ${data.page} of ${data.num_pages}</span></li>`;
                const liNext = `<li class="page-item ${data.has_next ? '' : 'disabled'}"><a class="page-link" href="#" data-page="${data.page + 1}">Next</a></li>`;
                pager.insertAdjacentHTML('beforeend', liPrev + liInfo + liNext);
            });
    }

    form.addEventListener('submit', (e) => { e.preventDefault(); fetchList(1); });
    pager.addEventListener('click', (e) => {
        if (e.target.matches('.page-link') && e.target.dataset.page) {
            e.preventDefault();
            const p = parseInt(e.target.dataset.page, 10);
            if (!isNaN(p)) fetchList(p);
        }
    });
</script>

<style>
    /* Make filter inputs & selects readable in dark theme */
    #filterForm .form-control,
    #filterForm .form-select {
        background-color: var(--secondary, #2b2b2b) !important;
        color: #f8f9fa !important;
        border: 1px solid #444;
    }

    /* White placeholders */
    #filterForm .form-control::placeholder {
        color: #f8f9fa !important;
        opacity: 0.8;
    }

    /* Focus style */
    #filterForm .form-control:focus,
    #filterForm .form-select:focus {
        border-color: var(--accent, #dc3545) !important;
        box-shadow: 0 0 6px rgba(220, 53, 69, 0.4);
    }

    /* Table hover fix */
    .hover-glow:hover {
        background-color: #2b2b2b !important;
        box-shadow: inset 0 0 8px rgba(220, 53, 69, 0.5);
        transition: 0.2s;
    }
</style>
{% endblock %}