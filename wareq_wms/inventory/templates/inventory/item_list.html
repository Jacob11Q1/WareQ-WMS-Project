{% extends "base.html" %}
{% block content %}
<div class="container py-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-light">
            <i class="bi bi-box-seam text-danger"></i> Items
        </h2>
        <a href="{% url 'inventory:item_create' %}" class="btn btn-danger">
            <i class="bi bi-plus"></i> Add Item
        </a>
    </div>

    <!-- Search & Filters -->
    <form method="get" class="mb-3 d-flex">
        <input type="text" name="q" class="form-control me-2" placeholder="Search by name, SKU, or supplier..."
            value="{{ query|default:'' }}">
        <button type="submit" class="btn btn-outline-light"><i class="bi bi-search"></i></button>
    </form>

    <!-- Table -->
    <div class="card shadow-lg bg-dark text-light">
        <div class="card-body table-responsive">
            <table class="table table-dark align-middle mb-0">
                <thead class="custom-thead">
                    <tr>
                        <th>#</th>
                        <th>SKU</th>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Supplier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr data-id="{{ item.id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ item.sku }}</td>
                        <td>
                            <a href="{% url 'inventory:item_detail' item.id %}" class="text-light fw-bold">
                                {{ item.name }}
                            </a>
                        </td>
                        <td>
                            <span class="quantity-text">
                                {% if item.quantity <= 5 %} <span class="badge bg-danger">{{ item.quantity }}</span>
                            {% else %}
                            {{ item.quantity }}
                            {% endif %}
                            </span>
                            <input type="number" class="form-control form-control-sm quantity-input d-none"
                                value="{{ item.quantity }}">
                        </td>
                        <td>${{ item.price }}</td>
                        <td>
                            {% if item.supplier %}
                            <a href="{% url 'suppliers:supplier_detail' item.supplier.id %}"
                                class="text-decoration-none text-light">
                                <i class="bi bi-truck"></i> {{ item.supplier.name }}
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning me-2 edit-btn">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success d-none save-btn">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <a href="{% url 'inventory:item_delete' item.id %}" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No items found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="mt-3">
                {% if items.has_other_pages %}
                <nav>
                    <ul class="pagination justify-content-center">
                        {% if items.has_previous %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ items.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">Previous</a>
                        </li>
                        {% endif %}
                        {% for num in items.paginator.page_range %}
                        {% if items.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                        <li class="page-item"><a class="page-link"
                                href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                        {% endfor %}
                        {% if items.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ items.next_page_number }}{% if query %}&q={{ query }}{% endif %}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- Inline Stock Update Script -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("tr[data-id]").forEach(row => {
            const editBtn = row.querySelector(".edit-btn");
            const saveBtn = row.querySelector(".save-btn");
            const qtyText = row.querySelector(".quantity-text");
            const qtyInput = row.querySelector(".quantity-input");
            const itemId = row.getAttribute("data-id");

            editBtn.addEventListener("click", () => {
                qtyText.classList.add("d-none");
                qtyInput.classList.remove("d-none");
                editBtn.classList.add("d-none");
                saveBtn.classList.remove("d-none");
            });

            saveBtn.addEventListener("click", () => {
                fetch(`/inventory/${itemId}/update-stock/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `amount=${qtyInput.value - parseInt(qtyText.textContent.trim())}&reason=Manual inline update`
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            qtyText.textContent = data.new_quantity;
                            qtyText.classList.remove("d-none");
                            qtyInput.classList.add("d-none");
                            editBtn.classList.remove("d-none");
                            saveBtn.classList.add("d-none");
                        } else {
                            alert(data.error);
                        }
                    });
            });
        });
    });
</script>

<style>
    /* Fix table header style */
    .custom-thead th {
        background-color: var(--secondary) !important;
        color: var(--text-color) !important;
        border-bottom: 2px solid var(--accent);
    }

    /* Keep table still (no hover expansion) */
    .table-dark tbody tr:hover {
        background-color: transparent !important;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Fix dropdowns and inputs visibility */
    .form-select,
    .form-control {
        background-color: var(--secondary) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--secondary);
    }

    .form-select:focus,
    .form-control:focus {
        border: 2px solid var(--accent) !important;
        box-shadow: none !important;
    }

    /* Fix white placeholder only in this page */
    .form-control::placeholder,
    .form-select::placeholder {
        color: #f8f9fa !important;
        /* White text */
        opacity: 0.8;
        /* Slightly dim */
    }
</style>
{% endblock %}